---
title: "How Anxiety/Depression Levels Differed Between States and Regions Following COVID-19"
date: last-modified
author: "Ian Walsh & Logan Rosell"
format: 
    html:
        embed-resources: true
jupyter: python3
---

```{python}
#| echo: false
#| include: false
# Load libraries
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.express as px
from scipy.stats import pearsonr
from sklearn.linear_model import LinearRegression
from sklearn.metrics import PredictionErrorDisplay
from scipy.stats import probplot
from statsmodels.stats.outliers_influence import variance_inflation_factor
import datetime

# Import datasets
state_data = pd.read_csv("state_data.csv")
state_data_wide = pd.read_csv("state_data_wide.csv")
# Reforming to date-time because CSV does not retain formatting
state_data['Time Period Start Date'] = pd.to_datetime(state_data['Time Period Start Date']).dt.date
state_data['Time Period End Date'] = pd.to_datetime(state_data['Time Period End Date']).dt.date

```

# Introduction

# Background

2-3 citations in background

# Methods

# Results

## Line Graph
```{python}
#| echo: false
format = '%b %d %Y'
federal_election = datetime.datetime.strptime('Nov 3 2020', format)
floyd_protests = datetime.datetime.strptime('May 25 2020', format)
covid_vaccine = datetime.datetime.strptime('Dec 11 2020', format)
roe_v_wade_overturned = datetime.datetime.strptime('Jun 24 2022', format)
us_mid_terms = datetime.datetime.strptime('Nov 8 2022', format)
covid_over = datetime.datetime.strptime('May 11 2023', format)
national_avgs = state_data.groupby(['Time Period Start Date', 'Indicator'], observed=False).agg(
    nat_means = ('Percent of Population', 'mean')
)
nat_avg_plt = sns.lineplot(national_avgs,
                            x='Time Period Start Date',
                            y='nat_means',
                            hue = 'Indicator')
plt.axvline(floyd_protests,
    color='purple',
    label='George Floyd Protests',
    linestyle='--',)
plt.axvline(federal_election,
    color='red',
    label='Federal Election',
    linestyle='-.',)
plt.axvline(covid_vaccine,
    color='black',
    label='Covid-19 Vaccine Approved',
    linestyle=':',)
plt.axvline(roe_v_wade_overturned,
    color='blue',
    label='Roe V. Wade is Overturned',
    linestyle='--',)
plt.axvline(us_mid_terms,
    color='#06754cff',
    label='Midterm Elections',
    linestyle='-.',)
plt.axvline(covid_over,
    color='orange',
    label='Covid-19 Public Health Emergency Over',
    linestyle=':',)
plt.xticks(rotation=45)
plt.title(f"Percent of Population Over Time")
plt.ylabel('Percent of Population')
plt.legend(title='Key',
    loc='right',
    bbox_to_anchor=(1.9, 0.5))
plt.show()
```

## Map Graph
```{python}
#| echo: false
min = state_data['Percent of Population'].min()
max = state_data['Percent of Population'].max()

fig = px.choropleth(
    state_data,
    locations='State Code',
    locationmode='USA-states',
    color='Percent of Population',
    facet_row='Symptoms Of',
    scope='usa',
    title='Map of Anxiety and Depression in US States Over Time',
    hover_name='State',
    color_continuous_scale='amp',
    animation_frame='Time Period Start Date',
    range_color=[min,max],
    height = 700
)
fig.show()
```

## Regression

```{python}
#| echo: false
x_data = state_data_wide[['Time Period',
        'Region_South',
        'Region_West',
        'Region_Northeast']].values
y_data = state_data_wide[['Perc of Pop with Symptoms of Either']]

symptoms_over_time_by_region = LinearRegression().fit(x_data,y_data)
score = symptoms_over_time_by_region.score(x_data, y_data)
predict = symptoms_over_time_by_region.predict(x_data)

print('model intercept :', symptoms_over_time_by_region.intercept_.round(3))
print('model coefficients : ', symptoms_over_time_by_region.coef_.round(3))
print('R-Squared: ', symptoms_over_time_by_region.score(x_data, y_data))
```

### Checks for LINE

```{python}
#| echo: false
display = PredictionErrorDisplay(y_true = y_data, y_pred = predict)
display.plot()
plt.show()

# Does not meet criteria for linearity or equal variance (L, E)
```

```{python}
#| echo: false
residuals = y_data - predict
residuals = np.ravel(residuals)

probplot(residuals, dist = 'norm', plot = plt)
plt.show()

# Data looks fairly normally distributed (N)
```

```{python}
#| echo: false
X = state_data_wide[['Time Period',
    'Region_South',
    'Region_West',
    'Region_Northeast']].copy()

X = X.astype(float)

X.insert(0, 'const', 1.0)

X_array = X.values

for i, col in enumerate(X.columns):
    vif = variance_inflation_factor(X_array, exog_idx=i)
    print(col, "VIF =", round(vif, 3))
```

```{python}
linaer_plot = sns.lmplot(state_data_wide,
    x='Time Period',
    y='Perc of Pop with Symptoms of Either',
    col= "Region",
    col_wrap = 2)
plt.show()
```

# Conclusion

# References

https://www.bbc.com/news/world-us-canada-52905408 (George Floyd Protest Timeline)
https://time.com/5920134/first-authorized-covid-19-vaccine-us/ (First Covid-19 Vaccine Approved)
https://archive.cdc.gov/www_cdc_gov/coronavirus/2019-ncov/your-health/end-of-phe.html (end of Covid emergency)